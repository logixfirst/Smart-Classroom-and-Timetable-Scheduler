name: Pull Request Validation (Non-blocking)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking for rapid development
    
    steps:
    - uses: actions/checkout@v4

    - name: PR Title Check
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
        requireScope: false

    - name: Check PR size
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        CHANGED_LINES=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertion)|\d+(?= deletion)' | awk '{s+=$1} END {print s}')
        
        echo "Changed files: $CHANGED_FILES"
        echo "Changed lines: $CHANGED_LINES"
        
        if [ "$CHANGED_FILES" -gt 50 ]; then
          echo "⚠️ Warning: PR is large ($CHANGED_FILES files). Consider breaking it down."
        fi
        
        if [ "$CHANGED_LINES" -gt 500 ]; then
          echo "⚠️ Warning: PR has many changes ($CHANGED_LINES lines). Consider breaking it down."
        fi

    - name: Check for TODO/FIXME comments
      run: |
        if git diff origin/${{ github.base_ref }}...HEAD | grep -E '^\+.*\b(TODO|FIXME|XXX|HACK)\b'; then
          echo "⚠️ Found TODO/FIXME comments in the changes"
          git diff origin/${{ github.base_ref }}...HEAD | grep -E '^\+.*\b(TODO|FIXME|XXX|HACK)\b'
        fi

  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install Danger
      run: npm install -g danger

    - name: Run Danger
      run: danger ci
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

  duplicate-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install jscpd
      run: npm install -g jscpd

    - name: Check for code duplication
      run: |
        jscpd backend/django/academics --min-lines 10 --min-tokens 50 || true
        jscpd frontend/src --min-lines 10 --min-tokens 50 || true

  conventional-commits:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate commit messages
      run: |
        COMMITS=$(git log --format=%s origin/${{ github.base_ref }}..HEAD)
        echo "$COMMITS" | while read commit; do
          if ! echo "$commit" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.+\))?: .+'; then
            echo "❌ Invalid commit message: $commit"
            echo "Commit messages should follow conventional commits format:"
            echo "  type(scope): description"
            exit 1
          fi
        done

  label-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check labels
      uses: mheap/github-action-required-labels@v5
      with:
        mode: minimum
        count: 1
        labels: "bug, feature, enhancement, documentation, refactor, dependencies"
